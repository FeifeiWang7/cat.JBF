#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <errno.h>
#include <pthread.h>
#define ERROR -1
#define BUFSIZE 16

void test1(void* arg);
void test2(void* arg);
void test3(void* arg);

int main()
{
	char *ptr = NULL;
	char data1[] = "mouse";
	char data2[] = "cheesecheesecheesecheesecheesechb.c";
	char data3[] = "cat";
	void *arg1[2] = {&ptr, data1};
	void *arg2[2] = {&ptr, data2};
	void *arg3[2] = {&ptr, data3};
	
	pthread_t thread1, thread2, thread3;
	int ret_thrd1, ret_thrd2, ret_thrd3;

	ret_thrd1 = pthread_create(&thread1, NULL, (void *)test1, arg1);
	ret_thrd2 = pthread_create(&thread2, NULL, (void *)test2, arg2);
	ret_thrd3 = pthread_create(&thread3, NULL, (void *)test3, arg3);

	if((ret_thrd1 != 0) || (ret_thrd2 != 0) || (ret_thrd3 != 0)) printf("fail to create threads.\n");

	pthread_join(thread1, NULL);
	pthread_join(thread2, NULL);
	pthread_join(thread3, NULL);
}

void test1(void* arg)
{
	char **ptr =((void**)arg)[0];
	char *data = ((void**)arg)[1];
	int len = strlen(data);
	if(*ptr == NULL)
	{
		printf("in1.\n");
		sleep(10);
		*ptr = malloc(len);
		memset(*ptr, 0, len);

			char *tmp = malloc(4);
		memset(*ptr, 0, len);
		memcpy(*ptr, data, len);
		printf("111 %s\n", *ptr);
	}
}
void test2(void* arg)
{
	char **ptr =((void**)arg)[0];
        char *data = ((void**)arg)[1];
        int len = strlen(data);
        if(*ptr == NULL)
        {
                printf("in2.\n");
		sleep(1);
                *ptr = malloc(len);
		memset(*ptr, 0, len);

                char *tmp = malloc(4);
		memset(tmp, 0, 4);
		memcpy(tmp, "a.c",4);

		printf("222 before tmp is: %s\n",tmp);
printf(" !222 %p %p\n", *ptr, tmp);
		sleep(1);
printf(" *222 %p %p\n", *ptr, tmp);
                memcpy(*ptr, data, len);
                printf("222 after tmp is: %s\n", tmp);
        }
}
void test3(void* arg)
{
	char **ptr =((void**)arg)[0];
        char *data = ((void**)arg)[1];
        int len = strlen(data);
        if(*ptr == NULL)
        {
                printf("in3.\n");
		sleep(2);
                *ptr = malloc(len);
		memset(*ptr, 0, len);

                char *tmp = malloc(4);
		memset(tmp, 0, 4);
		memcpy(tmp, "a.c",4);

		printf("333 before tmp is: %s\n",tmp);
printf(" !333 %p %p\n", *ptr, tmp);
                sleep(1);
printf(" *333 %p %p\n", *ptr, tmp);
                memcpy(*ptr, data, len);
                printf("333 after tmp is: %s\n", tmp);

        }
}


>./test 
in1.
in2.
in3.
222 before tmp is: a.c
 !222 0x7fec400008c0 0x7fec400008f0
333 before tmp is: a.c
 !333 0x7fec380008c0 0x7fec380008e0
 *222 0x7fec380008c0 0x7fec400008f0
222 after tmp is: a.c
 *333 0x7fec380008c0 0x7fec380008e0
333 after tmp is: b.c
111 mouse

